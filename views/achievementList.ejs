<%- include header %>
<link href="/basic/css/dataTables.bootstrap4.min.css" rel="stylesheet">
<script charset="utf-8" src="/dataTable/jquery.dataTables.min.js"></script>
<script charset="utf-8" src="/basic/js/dataTables.bootstrap4.min.js"></script>
<body>
<%- include nav2 %>
<div id="ifSearch" class="row" style="display: none;">
    <div class="col-sm-3 col-1"></div>
    <div class="col-sm-6 col-10">
        <div class="form-group">
            <label for="search1">活動名稱：</label>
            <input type="text" class="form-control" id="search1" placeholder="範例：2018共識營">
        </div>
        <div class="form-group">
            <label for="search2">執行團隊：</label>
            <input type="text" class="form-control" id="search2" placeholder="範例：虎科志工">
        </div>
        <div class="form-group">
            <label for="search3">活動地點：</label>
            <input type="text" class="form-control" id="search3" placeholder="範例：606台灣嘉義縣中埔鄉深坑村內灣2號 或 嘉義縣">
        </div>
        <div class="form-group">
            <label for="search4">活動開始日期(起)：</label>
            <input type="date" class="form-control" id="search4" />
            <label for="search5">活動開始日期(迄)：</label>
            <input type="date" class="form-control" id="search5" />
        </div>
        <div class="form-group">
            <label for="search6">活動結束日期(起)：</label>
            <input type="date" class="form-control" id="search6" />
            <label for="search7">活動結束日期(迄)：</label>
            <input type="date" class="form-control" id="search7" />
        </div>
        <div id="search" class="row" style="display: none;">
            <div class="col-sm-6 col-12">
                <input id="searchBtn" class="btn btn-block def-btn" style="margin-bottom: 10px;" type="button" value="查詢" />
                <input id="continueSearchBtn" class="btn btn-block def-btn" type="button" value="繼續查詢" style="margin-top: 0px;" />
            </div>
            <div class="col-sm-6 col-12">
                <input id="goMapBtn" class="btn btn-block" type="button" value="返回" />
            </div>
        </div>      
    </div>
    <div class="col-sm-3 col-1"></div>
</div>
<div id="switchIfSearch" class="row">
    <input id="switchIfSearchBtn" class="btn btn-block btn-primary" type="button" value="條件查詢" />
</div>
<!-- <div id="achiTableDiv" class="row" style="display: none; padding-top: 2px;">
    <div class="col-12">
        <table id="achiTable" class="table table-responsive-sm table-striped table-bordered text-nowrap" style="width: 100%">
        </table>
    </div>
</div> -->
<div id="map"></div>
<style>
    body {
        font-style: '微軟正黑體'
    }
</style>
<script>
    const data = <%- docs %>;
    const monthForamt = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
    const achiTable = $("#achiTable").DataTable({
            "data": data,
            "processing" : true,
            "responsive": true,
            "columns": [
                { "title": "活動名稱", "data": "ACT_NAME" },
                { "title": "活動執行團隊", "data": "TEAM_NAME" },
                { "title": "活動執行地點", "data": "ACT_LOCATION.LOCATION_ADDR" },
                { "title": "活動開始時間", "data": "ACT_BEG_DATE", 
                    "fnCreatedCell": function(td, cData, rData, rIndex, cIndex) {
                        var date = new Date(parseInt(cData));
                        var month,hour,minute = '00';
                        var day = parseInt(date.getDate());

                        if(day < 10)
                            day = '0' + day;
                            
                        if(parseInt(date.getHours()) < 10)
                            hour = '0' + date.getHours();
                        else
                            hour = date.getHours();

                        if(parseInt(date.getMinutes()) < 10)
                            minute = '0' + date.getMinutes();
                        else
                            minute = date.getMinutes();
                        $(td).html(date.getFullYear() + '年' + monthForamt[date.getMonth()] + '月' + day + '日  '+ hour + ':' + minute);
                    }},
                { "title": "活動結束時間", "data": "ACT_END_DATE", 
                    "fnCreatedCell": function(td, cData, rData, rIndex, cIndex) {
                        var date = new Date(parseInt(cData));
                        var month,hour,minute = '00';
                        var day = parseInt(date.getDate());

                        if(day < 10)
                            day = '0' + day;
                            
                        if(parseInt(date.getHours()) < 10)
                            hour = '0' + date.getHours();
                        else
                            hour = date.getHours();

                        if(parseInt(date.getMinutes()) < 10)
                            minute = '0' + date.getMinutes();
                        else
                            minute = date.getMinutes();
                        $(td).html(date.getFullYear() + '年' + monthForamt[date.getMonth()] + '月' + day + '日  '+ hour + ':' + minute);
                    }},
            ]
        });
    
    $('#switchIfSearchBtn').click(() => {
        $('#map').hide();
        $('#ifSearch').show();
        $('#switchIfSearch').hide();
        $('#search').show();
        $('#continueSearchBtn').hide();
        $('#searchBtn').show();
    });
    
    $('#goMapBtn').click(() => {
        $('#map').show();
        $('#ifSearch').hide();
        $('#search').hide();
        $('#switchIfSearch').show();
        $('#achiTableDiv').hide();
    });

    $('#continueSearchBtn').click(() => {
        $('#map').hide();
        $('#ifSearch').show();
        $('#switchIfSearch').hide();
        $('#search').show();
        $('#searchBtn').show();
        $('#achiTableDiv').hide();
        $('#continueSearchBtn').hide()
    });

    $('#searchBtn').click(() => {
        let input = [];
        input.push($('#search1').val());
        input.push($('#search2').val());
        input.push($('#search3').val());
        input.push($('#search4').val());
        input.push($('#search5').val());
        input.push($('#search6').val());
        input.push($('#search7').val());
        console.log(input);
        $('#ifSearch').hide(); 
        $('#achiTableDiv').show();
        $('#continueSearchBtn').show();
        $('#searchBtn').hide();
        achiTable
            .columns( 0 )
            .search( input[0] )
            .columns( 1 )
            .search( input[1] )
            .columns( 2 )
            .search( input[2] )
            .draw();
        achiTable.draw();
    });
    $.fn.dataTable.ext.search.push(
        function( settings, data, dataIndex ) {
            let min  = parseInt(Date.parse($('#search4').val()), 10);
            let max  = parseInt(Date.parse($('#search5').val()), 10);
            let createdAt = data[3] || 0; // Our date column in the table

            if ( ( isNaN( min ) && isNaN( max ) ) ||
                ( isNaN( min ) && createdAt <= max ) ||
                ( min <= createdAt && isNaN( max ) ) ||
                ( min <= createdAt && createdAt <= max ) )
            {
                console.log('true');
                return true;
            }
            console.log('false');
            return false;
        }
    );
    $.fn.dataTable.ext.search.push(
        function( settings, data, dataIndex ) {
            let min  = parseInt(Date.parse($('#search6').val()), 10);
            let max  = parseInt(Date.parse($('#search7').val()), 10);
            let createdAt = data[4] || 0; // Our date column in the table
            
            if ( ( isNaN( min ) && isNaN( max ) ) ||
                ( isNaN( min ) && createdAt <= max ) ||
                ( min <= createdAt && isNaN( max ) ) ||
                ( min <= createdAt && createdAt <= max ) )
            {
                console.log('true');
                return true;
            }
            console.log('false');
            return false;
        }
    );
</script>
<script>
    var map;
    var result = <%- docs %>
    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 23.7031129, lng: 120.4279623},
        zoom: 12
        });

        result.forEach((doc, i) => {
            console.log(doc);
            if(doc.teamLogo)
                var image = {
                    url: doc.teamLogo,
                    // This marker is 20 pixels wide by 32 pixels high.
                    size: new google.maps.Size(40, 40),      //顯示圖片大小
                    origin: new google.maps.Point(0, 0),     //起始位置，通常為0
                    anchor: new google.maps.Point(19, 40),   //移動marker 數字越大往右和往上移動
                    scaledSize: new google.maps.Size(40, 40) //圖片實際大小，通常與size一樣大小
                };
            else
                var image = {
                    url: '/images/nfu_icon.png',
                    // This marker is 20 pixels wide by 32 pixels high.
                    size: new google.maps.Size(40, 40),      //顯示圖片大小
                    origin: new google.maps.Point(0, 0),     //起始位置，通常為0
                    anchor: new google.maps.Point(19, 40),   //移動marker 數字越大往右和往上移動
                    scaledSize: new google.maps.Size(40, 40) //圖片實際大小，通常與size一樣大小
                };
            var uluru = {lat: doc.ACT_LOCATION.LOCATION_LAT, lng: doc.ACT_LOCATION.LOCATION_LNG};
            var marker = new google.maps.Marker({
                position: uluru, 
                map: map, 
                icon: image,
                animation: google.maps.Animation.DROP
            });
            var contentString = '<div id="content" class="contentDIV">'+
                '<div id="siteNotice">'+ 
                '</div>'+
                '<h3 id="firstHeading" class="firstHeading"><a href="/achievement/2/' + result[i]._id + '">' +
                result[i].ACT_NAME + '</a></h3><p class="mapCotent">' + result[i].ACHI_STORE + '</p></div>';
            

            var infowindow = new google.maps.InfoWindow({
                content: contentString
            });

            marker.addListener('mouseover', function() {
                infowindow.open(map, marker);
            });

            marker.addListener('click', function() {
                infowindow.open(map, marker);
                setTimeout(function () { infowindow.close(); }, 3000);
            });

            marker.addListener('mouseout', function() {
                setTimeout(function () { infowindow.close(); }, 3000);
            });
        });
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA6MrbT0cNZgeYP3JUP4R2U-WZDbWVzWM8&callback=initMap"
    async defer></script>
<style>
    #map {
        height: 500px;
    }
    .mapCotent {
        height: 50px;
        overflow : hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }
    @media only screen and (max-width: 768px) {
        #map {
            height: 700px;
        }

        .def_btn {
            margin-bottom: 10px;
        }

        .contentDIV {
            width: 300px;
            height: 150px;
        }
    }
</style>
<%- include newfooter %>
</body>